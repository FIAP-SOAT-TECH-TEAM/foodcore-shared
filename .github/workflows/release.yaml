name: CI & Release Pipeline

on:
  push:
    branches:
      - main
      - master
      - dev
  pull_request:
    branches:
      - main
      - teste

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_VAR_foodcore-backend-resource-group: ${{ secrets.BACKEND_AZURE_RESOURCE_GROUP_NAME }}
  TF_VAR_foodcore-backend-storage-account: ${{ secrets.BACKEND_AZURE_STORAGE_ACCOUNT_NAME }}
  TF_VAR_foodcore-backend-container: ${{ secrets.BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME }}
  TF_VAR_foodcore-backend-infra-key: ${{ secrets.FOODCORE_INFRA_BACKEND_AZURE_KEY }}
  TF_VAR_foodcore-backend-auth-key: ${{ secrets.FOODCORE_AUTH_BACKEND_AZURE_KEY }}

  TF_VAR_chart_name: "foodcoreapi"
  TF_VAR_swagger_path: "../build/openapi/swagger.json"

  TF_VAR_mercadopago_base_url: ${{ secrets.FOODCORE_API_MP_BASE_URL }}
  TF_VAR_mercadopago_token: ${{ secrets.FOODCORE_API_MP_TOKEN }}
  TF_VAR_mercadopago_user_id: ${{ secrets.FOODCORE_API_MP_USER_ID }}
  TF_VAR_mercadopago_pos_id: ${{ secrets.FOODCORE_API_MP_POS_ID }}

jobs:
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      is_release: ${{ steps.set-version.outputs.is_release }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install semantic-release
        run: npm install -g semantic-release @semantic-release/git @semantic-release/changelog @semantic-release/github

      - name: Detect version
        id: set-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if semantic-release --dry-run | tee output.log | grep -q "The next release version is"; then
            VERSION=$(grep "The next release version is" output.log | awk '{print $NF}')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  infra-info:
    runs-on: ubuntu-latest
    needs: versioning
    outputs:
      acr_login_server: ${{ steps.acr.outputs.acr_login_server }}

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.BACKEND_AZURE_RESOURCE_GROUP_NAME }}" \
            -backend-config="storage_account_name=${{ secrets.BACKEND_AZURE_STORAGE_ACCOUNT_NAME }}" \
            -backend-config="container_name=${{ secrets.BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME }}" \
            -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -backend-config="key=${{ secrets.BACKEND_AZURE_KEY }}"

      - name: Terraform Refresh
        working-directory: terraform
        run: terraform apply --refresh-only --auto-approve

      - name: Get ACR Login Server
        id: acr
        working-directory: terraform
        run: echo "acr_login_server=$(terraform output -raw acr_login_server_from_remote)" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: infra-info

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v3
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - run: chmod +x gradlew

      - name: Build & Test
        run: ./gradlew build test jacocoTestReport

      - name: SonarCloud
        run: |
          ./gradlew sonar \
            -Dsonar.projectKey="${{ secrets.SONAR_CLOUD_PROJ_KEY }}" \
            -Dsonar.organization="${{ secrets.SONAR_CLOUD_ORG_KEY }}" \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token="${{ secrets.SONAR_CLOUD_TOKEN }}" \
            -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \
            -Dsonar.qualitygate.wait=true

      - name: Generate OpenAPI
        run: ./gradlew generateOpenAPI
        env:
          SERVER_CONTEXT_PATH: "/api"

      - uses: actions/upload-artifact@v4
        with:
          name: openapi
          path: build/openapi/swagger.json

  package:
    runs-on: ubuntu-latest
    needs: [build, infra-info, versioning]

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Docker Login
        run: az acr login --name ${{ needs.infra-info.outputs.acr_login_server }}

      - name: Build & Push Docker
        run: |
          IMAGE=${{ needs.infra-info.outputs.acr_login_server }}/foodcoreapi:${{ needs.versioning.outputs.version }}
          docker build -t $IMAGE -f docker/Dockerfile .
          docker push $IMAGE

      - name: Build & Push Helm Chart
        run: |
          VERSION=${{ needs.versioning.outputs.version }}
          sed -i "s/^version:.*/version: $VERSION/" kubernetes/foodcoreapi/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: $VERSION/" kubernetes/foodcoreapi/Chart.yaml
          helm dependency update kubernetes/foodcoreapi
          helm package kubernetes/foodcoreapi -d ./charts
          helm push ./charts/foodcoreapi-*.tgz oci://${{ needs.infra-info.outputs.acr_login_server }}/helm

  terraform:
    runs-on: ubuntu-latest
    needs: package

    env:
      TF_VAR_docker_image_uri: "${{ needs.infra-info.outputs.acr_login_server }}/foodcoreapi"
      TF_VAR_docker_image_tag: "${{ needs.versioning.outputs.version }}"

    defaults:
      run:
        working-directory: terraform

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v2

      - uses: actions/download-artifact@v4
        with:
          name: openapi
          path: build/openapi

      - run: terraform fmt
      - run: terraform validate
      - run: terraform plan -out=tfplan

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan

  release:
    runs-on: ubuntu-latest
    needs: [terraform, versioning]
    if: needs.versioning.outputs.is_release == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm install -g semantic-release @semantic-release/git @semantic-release/changelog @semantic-release/github

      - run: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}